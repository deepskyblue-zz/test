<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>초등학교 출결 관리 시스템</title>
    <style>
        body {
            font-family: 'Nanum Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #3f51b5;
            text-align: center;
            margin-bottom: 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }
        th {
            background-color: #3f51b5;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #3f51b5;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #303f9f;
        }
        .status-btn {
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 55px;
            text-align: center;
        }
        .present {
            background-color: #4CAF50;
            color: white;
        }
        .absent {
            background-color: #F44336;
            color: white;
        }
        .late {
            background-color: #FF9800;
            color: white;
        }
        .initial {
            background-color: #E0E0E0;
        }
        .save-section {
            margin-top: 20px;
            text-align: right;
        }
        .loader {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .message {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>초등학교 출결 관리 시스템</h1>
        
        <div class="header">
            <div class="date-selector">
                <label for="date">날짜:</label>
                <input type="date" id="date" name="date">
                <button id="load-btn">출결 불러오기</button>
            </div>
            <div>
                <select id="class-select">
                    <option value="1">1반</option>
                    <option value="2">2반</option>
                    <option value="3">3반</option>
                    <option value="4">4반</option>
                </select>
            </div>
        </div>
        
        <div id="message" class="message"></div>
        <div id="loader" class="loader">불러오는 중...</div>
        
        <table id="attendance-table">
            <thead>
                <tr>
                    <th>번호</th>
                    <th>이름</th>
                    <th>출결 상태</th>
                    <th>메모</th>
                </tr>
            </thead>
            <tbody id="attendance-body"></tbody>
        </table>
        
        <div class="save-section">
            <button id="save-btn">저장하기</button>
        </div>
    </div>

    <script>
        // 구글 스프레드시트 API 연동 스크립트
        document.addEventListener('DOMContentLoaded', function() {
            // 현재 날짜 설정
            const today = new Date();
            const dateInput = document.getElementById('date');
            dateInput.valueAsDate = today;
            
            // 샘플 학생 데이터 (실제로는 스프레드시트에서 가져올 예정)
            const sampleStudents = {
                "1": [
                    { id: 1, name: "김민준", status: "", memo: "" },
                    { id: 2, name: "이서연", status: "", memo: "" },
                    { id: 3, name: "박지훈", status: "", memo: "" },
                    { id: 4, name: "최예은", status: "", memo: "" },
                    { id: 5, name: "정도윤", status: "", memo: "" }
                ],
                "2": [
                    { id: 1, name: "강하은", status: "", memo: "" },
                    { id: 2, name: "윤서준", status: "", memo: "" },
                    { id: 3, name: "임지안", status: "", memo: "" },
                    { id: 4, name: "한소율", status: "", memo: "" },
                    { id: 5, name: "오민서", status: "", memo: "" }
                ],
                "3": [
                    { id: 1, name: "신유진", status: "", memo: "" },
                    { id: 2, name: "조준우", status: "", memo: "" },
                    { id: 3, name: "황현우", status: "", memo: "" },
                    { id: 4, name: "송지우", status: "", memo: "" },
                    { id: 5, name: "권하늘", status: "", memo: "" }
                ],
                "4": [
                    { id: 1, name: "홍서영", status: "", memo: "" },
                    { id: 2, name: "남도현", status: "", memo: "" },
                    { id: 3, name: "류아린", status: "", memo: "" },
                    { id: 4, name: "백승우", status: "", memo: "" },
                    { id: 5, name: "고은솔", status: "", memo: "" }
                ]
            };
            
            const classSelect = document.getElementById('class-select');
            const loadBtn = document.getElementById('load-btn');
            const saveBtn = document.getElementById('save-btn');
            const attendanceBody = document.getElementById('attendance-body');
            const messageDiv = document.getElementById('message');
            const loaderDiv = document.getElementById('loader');
            
            // 출결 상태 변경 함수
            function toggleStatus(button) {
                const statuses = ['', 'present', 'late', 'absent'];
                let currentIndex = statuses.indexOf(button.dataset.status);
                currentIndex = (currentIndex + 1) % statuses.length;
                
                // 모든 클래스 제거
                button.classList.remove('initial', 'present', 'late', 'absent');
                
                // 새 상태 설정
                const newStatus = statuses[currentIndex];
                button.dataset.status = newStatus;
                
                if (newStatus === '') {
                    button.classList.add('initial');
                    button.textContent = '선택';
                } else if (newStatus === 'present') {
                    button.classList.add('present');
                    button.textContent = '출석';
                } else if (newStatus === 'late') {
                    button.classList.add('late');
                    button.textContent = '지각';
                } else {
                    button.classList.add('absent');
                    button.textContent = '결석';
                }
            }
            
            // 학생 목록 표시 함수
            function displayStudents(classId) {
                attendanceBody.innerHTML = '';
                const students = sampleStudents[classId];
                
                students.forEach(student => {
                    const row = document.createElement('tr');
                    
                    const idCell = document.createElement('td');
                    idCell.textContent = student.id;
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = student.name;
                    
                    const statusCell = document.createElement('td');
                    const statusBtn = document.createElement('button');
                    statusBtn.classList.add('status-btn', 'initial');
                    statusBtn.textContent = '선택';
                    statusBtn.dataset.status = '';
                    statusBtn.onclick = function() {
                        toggleStatus(this);
                    };
                    statusCell.appendChild(statusBtn);
                    
                    const memoCell = document.createElement('td');
                    const memoInput = document.createElement('input');
                    memoInput.type = 'text';
                    memoInput.placeholder = '메모 입력';
                    memoInput.value = student.memo;
                    memoCell.appendChild(memoInput);
                    
                    row.appendChild(idCell);
                    row.appendChild(nameCell);
                    row.appendChild(statusCell);
                    row.appendChild(memoCell);
                    
                    attendanceBody.appendChild(row);
                });
            }
            
            // 초기 학생 목록 로드
            displayStudents(classSelect.value);
            
            // 반 변경 시 학생 목록 업데이트
            classSelect.addEventListener('change', function() {
                displayStudents(this.value);
            });
            
            // 출결 데이터 불러오기 (실제로는 구글 스프레드시트 API 사용)
            loadBtn.addEventListener('click', function() {
                const selectedDate = dateInput.value;
                const selectedClass = classSelect.value;
                
                // 로딩 표시
                loaderDiv.style.display = 'block';
                messageDiv.style.display = 'none';
                
                // API 호출 시뮬레이션
                setTimeout(() => {
                    loaderDiv.style.display = 'none';
                    messageDiv.className = 'message success';
                    messageDiv.textContent = `${selectedDate} ${selectedClass}반 출결 데이터를 불러왔습니다.`;
                    messageDiv.style.display = 'block';
                    
                    // 실제로는 여기서 스프레드시트 데이터 처리
                    displayStudents(selectedClass);
                }, 1000);
            });
            
            // 출결 데이터 저장하기 (실제로는 구글 스프레드시트 API 사용)
            saveBtn.addEventListener('click', function() {
                const selectedDate = dateInput.value;
                const selectedClass = classSelect.value;
                
                // 데이터 수집
                const attendanceData = [];
                const rows = attendanceBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const id = row.cells[0].textContent;
                    const name = row.cells[1].textContent;
                    const statusBtn = row.cells[2].querySelector('.status-btn');
                    const status = statusBtn.dataset.status;
                    const memo = row.cells[3].querySelector('input').value;
                    
                    attendanceData.push({
                        id,
                        name,
                        status,
                        memo,
                        date: selectedDate,
                        class: selectedClass
                    });
                });
                
                // 로딩 표시
                loaderDiv.style.display = 'block';
                messageDiv.style.display = 'none';
                
                // API 호출 시뮬레이션
                setTimeout(() => {
                    loaderDiv.style.display = 'none';
                    messageDiv.className = 'message success';
                    messageDiv.textContent = `${selectedDate} ${selectedClass}반 출결 데이터가 저장되었습니다.`;
                    messageDiv.style.display = 'block';
                    
                    console.log('저장된 데이터:', attendanceData);
                    // 실제로는 여기서 Google Sheets API 호출
                }, 1000);
            });
        });
        

        // 1. 구글 API 로드
        function loadGoogleAPI() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = loadGAPIClient;
            document.body.appendChild(script);
        }
        
        // 2. GAPI 클라이언트 로드
        function loadGAPIClient() {
            gapi.load('client:auth2', initGAPIClient);
        }
        
        // 3. API 클라이언트 초기화
        function initGAPIClient() {
            gapi.client.init({
                apiKey: 'AIzaSyBigbxljKeki5dM_BtDanH7wgLlpnAkPwc',
                clientId: '508855930338-8vdgs24bkmtog2aqivmb83erfbob6g1q.apps.googleusercontent.com',
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                scope: 'https://www.googleapis.com/auth/spreadsheets'
            }).then(function() {
                // 인증 상태 리스너
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                // 초기 인증 상태 설정
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            });
        }
        
        // 4. 인증 상태 업데이트
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                // 로그인 성공, 데이터 로드 준비 완료
                document.getElementById('load-btn').disabled = false;
                document.getElementById('save-btn').disabled = false;
            } else {
                // 로그인 필요
                document.getElementById('load-btn').disabled = true;
                document.getElementById('save-btn').disabled = true;
                gapi.auth2.getAuthInstance().signIn();
            }
        }
        
        // 5. 스프레드시트에서 데이터 불러오기
        function loadFromSpreadsheet(date, classId) {
            return gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1oTXIE5sF8As54IEszmf2HJr1Dqyz4bOWmF9uU7B5ev4',
                range: `${classId}!A:E`, // 범위 지정
            }).then(function(response) {
                const range = response.result;
                if (range.values.length > 0) {
                    // 데이터 처리
                    return range.values;
                } else {
                    console.log('데이터가 없습니다.');
                    return [];
                }
            }, function(response) {
                console.error('데이터 불러오기 실패:', response.result.error.message);
                return [];
            });
        }
        
        // 6. 스프레드시트에 데이터 저장하기
        function saveToSpreadsheet(data, classId) {
            const values = data.map(item => [
                item.date,
                item.id,
                item.name,
                item.status,
                item.memo
            ]);
            
            return gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: '1oTXIE5sF8As54IEszmf2HJr1Dqyz4bOWmF9uU7B5ev4',
                range: `${classId}!A:E`,
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS',
                resource: {
                    values: values
                }
            }).then(function(response) {
                console.log('저장 성공:', response.result);
                return true;
            }, function(response) {
                console.error('저장 실패:', response.result.error.message);
                return false;
            });
        }
        
        // 구글 API 로드 시작
        loadGoogleAPI();
    </script>
</body>
</html>
